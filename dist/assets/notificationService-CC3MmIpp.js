import{r as u,u as d,a as s,C as n}from"./main-C7B5hG3I.js";const r=u("PushNotifications",{});class h{api=d();notifications=s([]);unreadCount=s(0);isInitialized=s(!1);pollInterval=null;pushToken=null;constructor(){this.setupPolling()}async initialize(){if(!this.isInitialized.value)try{await this.loadNotifications(),n.isNativePlatform()?await this.initializePushNotifications():await this.initializeWebPushNotifications(),this.isInitialized.value=!0}catch(i){console.error("Erreur lors de l'initialisation des notifications:",i)}}async initializeWebPushNotifications(){try{if(!("Notification"in window)||!("serviceWorker"in navigator)){console.warn("Ce navigateur ne supporte pas les notifications push");return}let i=Notification.permission;if(i==="default"&&(i=await Notification.requestPermission()),i!=="granted"){console.warn("Permission de notifications refus√©e");return}const a=await(await navigator.serviceWorker.register("/sw.js",{scope:"/"})).pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(await this.getVapidPublicKey())});await this.registerWebPushSubscription(a),console.log("‚úÖ Notifications Web Push initialis√©es")}catch(i){console.error("Erreur lors de l'initialisation des notifications Web Push:",i)}}async getVapidPublicKey(){try{return(await this.api.api.get("/notifications/vapid-public-key")).data?.public_key||""}catch(i){return console.error("Erreur lors de la r√©cup√©ration de la cl√© VAPID:",i),""}}urlBase64ToUint8Array(i){const e="=".repeat((4-i.length%4)%4),a=(i+e).replace(/\-/g,"+").replace(/_/g,"/"),t=window.atob(a),l=new Uint8Array(t.length);for(let o=0;o<t.length;++o)l[o]=t.charCodeAt(o);return l}async registerWebPushSubscription(i){try{const e={endpoint:i.endpoint,keys:{p256dh:this.arrayBufferToBase64(i.getKey("p256dh")),auth:this.arrayBufferToBase64(i.getKey("auth"))}};await this.api.api.post("/notifications/register-web-push",{subscription:e,device_type:"web"}),console.log("‚úÖ Subscription Web Push enregistr√©e sur le backend")}catch(e){console.error("Erreur lors de l'enregistrement de la subscription Web Push:",e)}}arrayBufferToBase64(i){const e=new Uint8Array(i);let a="";for(let t=0;t<e.byteLength;t++)a+=String.fromCharCode(e[t]);return window.btoa(a)}async initializePushNotifications(){try{let i=await r.checkPermissions();if(i.receive==="prompt"&&(i=await r.requestPermissions()),i.receive!=="granted"){console.warn("Permissions de notifications refus√©es");return}await r.register(),r.addListener("registration",async e=>{console.log("üì± Token push enregistr√©:",e.value),this.pushToken=e.value,await this.registerDeviceToken(e.value)}),r.addListener("registrationError",e=>{console.error("Erreur d'enregistrement push:",e)}),r.addListener("pushNotificationReceived",e=>{console.log("üì¨ Notification re√ßue:",e),this.loadNotifications()}),r.addListener("pushNotificationActionPerformed",e=>{console.log("üëÜ Action sur notification:",e),e.notification.data?.action_url&&(window.location.href=e.notification.data.action_url)})}catch(i){console.error("Erreur lors de l'initialisation des notifications push:",i)}}async registerDeviceToken(i){try{const e=n.getPlatform()==="android"?"android":n.getPlatform()==="ios"?"ios":"web";await this.api.api.post("/notifications/register-device",{device_token:i,device_type:e}),console.log("‚úÖ Token d'appareil enregistr√© sur le backend")}catch(e){console.error("Erreur lors de l'enregistrement du token:",e)}}async loadNotifications(){try{const e=(await this.api.api.get("/notifications")).data;e?.data&&Array.isArray(e.data)?this.notifications.value=e.data:Array.isArray(e)&&(this.notifications.value=e),await this.loadUnreadCount()}catch(i){console.error("Erreur lors du chargement des notifications:",i)}}async loadUnreadCount(){try{const i=await this.api.api.get("/notifications/unread-count");this.unreadCount.value=i.data?.count||0}catch(i){console.error("Erreur lors du chargement du nombre de notifications non lues:",i)}}async markAsRead(i){try{return await this.api.api.post(`/notifications/${i}/read`),await this.loadNotifications(),!0}catch(e){return console.error("Erreur lors du marquage de la notification:",e),!1}}async markAllAsRead(){try{return await this.api.api.post("/notifications/read-all"),await this.loadNotifications(),!0}catch(i){return console.error("Erreur lors du marquage de toutes les notifications:",i),!1}}async deleteNotification(i){try{return await this.api.api.delete(`/notifications/${i}`),await this.loadNotifications(),!0}catch(e){return console.error("Erreur lors de la suppression de la notification:",e),!1}}async disablePushNotifications(){try{return await this.api.api.post("/notifications/disable"),this.pushToken=null,!0}catch(i){return console.error("Erreur lors de la d√©sactivation des notifications:",i),!1}}setupPolling(){this.pollInterval=window.setInterval(()=>{this.isInitialized.value&&this.loadUnreadCount()},3e4)}cleanup(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null)}getNotifications(){return this.notifications}getUnreadCount(){return this.unreadCount}getIsInitialized(){return this.isInitialized}}let c=null;function g(){return c||(c=new h),c}export{g as useNotificationService};
