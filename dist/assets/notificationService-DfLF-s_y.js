import{r as u,u as d,a,C as n}from"./main-Ddag5VAa.js";const o=u("PushNotifications",{});class p{api=d();notifications=a([]);unreadCount=a(0);isInitialized=a(!1);pollInterval=null;pushToken=null;constructor(){this.setupPolling()}async initialize(){if(!this.isInitialized.value)try{await this.loadNotifications(),n.isNativePlatform()?await this.initializePushNotifications():await this.initializeWebPushNotifications(),this.isInitialized.value=!0}catch(e){console.error("Erreur lors de l'initialisation des notifications:",e)}}async initializeWebPushNotifications(){try{if(!("Notification"in window)||!("serviceWorker"in navigator)){console.warn("Ce navigateur ne supporte pas les notifications push");return}let e=Notification.permission;if(e==="default"&&(e=await Notification.requestPermission()),e!=="granted"){console.warn("Permission de notifications refus√©e");return}const t=await(await navigator.serviceWorker.register("/sw.js",{scope:"/"})).pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(await this.getVapidPublicKey())});await this.registerWebPushSubscription(t),console.log("‚úÖ Notifications Web Push initialis√©es")}catch(e){console.error("Erreur lors de l'initialisation des notifications Web Push:",e)}}async getVapidPublicKey(){try{return(await this.api.api.get("/notifications/vapid-public-key")).data?.public_key||""}catch(e){return console.error("Erreur lors de la r√©cup√©ration de la cl√© VAPID:",e),""}}urlBase64ToUint8Array(e){const i="=".repeat((4-e.length%4)%4),t=(e+i).replace(/\-/g,"+").replace(/_/g,"/"),r=window.atob(t),l=new Uint8Array(r.length);for(let s=0;s<r.length;++s)l[s]=r.charCodeAt(s);return l}async registerWebPushSubscription(e){try{const i={endpoint:e.endpoint,keys:{p256dh:this.arrayBufferToBase64(e.getKey("p256dh")),auth:this.arrayBufferToBase64(e.getKey("auth"))}};await this.api.api.post("/notifications/register-web-push",{subscription:i,device_type:"web"}),console.log("‚úÖ Subscription Web Push enregistr√©e sur le backend")}catch(i){console.error("Erreur lors de l'enregistrement de la subscription Web Push:",i)}}arrayBufferToBase64(e){const i=new Uint8Array(e);let t="";for(let r=0;r<i.byteLength;r++)t+=String.fromCharCode(i[r]);return window.btoa(t)}async initializePushNotifications(){try{console.log("üîî Initialisation des notifications push Capacitor...");let e=await o.checkPermissions();if(console.log("üìã √âtat des permissions:",e),e.receive==="prompt"&&(e=await o.requestPermissions(),console.log("üìã Permissions demand√©es, nouvel √©tat:",e)),e.receive!=="granted"){console.warn("‚ö†Ô∏è Permissions de notifications refus√©es:",e);return}console.log("‚úÖ Permissions accord√©es, enregistrement du service push..."),await o.register(),console.log("‚úÖ Service push enregistr√©, attente du token..."),o.addListener("registration",async i=>{console.log("üì± Token push re√ßu:",i.value),console.log("üì± Longueur du token:",i.value?.length),this.pushToken=i.value;try{await this.registerDeviceToken(i.value),console.log("‚úÖ Token enregistr√© avec succ√®s sur le backend")}catch(t){console.error("‚ùå Erreur lors de l'enregistrement du token:",t)}}),o.addListener("registrationError",i=>{console.error("‚ùå Erreur d'enregistrement push:",i),console.error("‚ùå D√©tails de l'erreur:",JSON.stringify(i,null,2))}),o.addListener("pushNotificationReceived",i=>{console.log("üì¨ Notification re√ßue:",i),this.loadNotifications()}),o.addListener("pushNotificationActionPerformed",i=>{console.log("üëÜ Action sur notification:",i),i.notification.data?.action_url&&(window.location.href=i.notification.data.action_url)}),console.log("‚úÖ √âcouteurs d'√©v√©nements push configur√©s")}catch(e){console.error("‚ùå Erreur lors de l'initialisation des notifications push:",e),console.error("‚ùå D√©tails:",e instanceof Error?e.message:String(e)),console.error("‚ùå Stack:",e instanceof Error?e.stack:"N/A")}}async registerDeviceToken(e){try{const i=n.getPlatform()==="android"?"android":n.getPlatform()==="ios"?"ios":"web";console.log("üì§ Envoi du token au backend...",{deviceType:i,tokenLength:e.length,tokenPreview:e.substring(0,20)+"..."});const t=await this.api.api.post("/notifications/register-device",{device_token:e,device_type:i});console.log("‚úÖ Token d'appareil enregistr√© sur le backend",t.data)}catch(i){throw console.error("‚ùå Erreur lors de l'enregistrement du token:",i),console.error("‚ùå D√©tails:",{message:i?.message,response:i?.response?.data,status:i?.response?.status}),i}}async loadNotifications(){try{const i=(await this.api.api.get("/notifications")).data;i?.data&&Array.isArray(i.data)?this.notifications.value=i.data:Array.isArray(i)&&(this.notifications.value=i),await this.loadUnreadCount()}catch(e){console.error("Erreur lors du chargement des notifications:",e)}}async loadUnreadCount(){try{const e=await this.api.api.get("/notifications/unread-count");this.unreadCount.value=e.data?.count||0}catch(e){console.error("Erreur lors du chargement du nombre de notifications non lues:",e)}}async markAsRead(e){try{return await this.api.api.post(`/notifications/${e}/read`),await this.loadNotifications(),!0}catch(i){return console.error("Erreur lors du marquage de la notification:",i),!1}}async markAllAsRead(){try{return await this.api.api.post("/notifications/read-all"),await this.loadNotifications(),!0}catch(e){return console.error("Erreur lors du marquage de toutes les notifications:",e),!1}}async deleteNotification(e){try{return await this.api.api.delete(`/notifications/${e}`),await this.loadNotifications(),!0}catch(i){return console.error("Erreur lors de la suppression de la notification:",i),!1}}async disablePushNotifications(){try{return await this.api.api.post("/notifications/disable"),this.pushToken=null,!0}catch(e){return console.error("Erreur lors de la d√©sactivation des notifications:",e),!1}}setupPolling(){this.pollInterval=window.setInterval(()=>{this.isInitialized.value&&this.loadUnreadCount()},3e4)}cleanup(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null)}getNotifications(){return this.notifications}getUnreadCount(){return this.unreadCount}getIsInitialized(){return this.isInitialized}}let c=null;function g(){return c||(c=new p),c}export{g as useNotificationService};
